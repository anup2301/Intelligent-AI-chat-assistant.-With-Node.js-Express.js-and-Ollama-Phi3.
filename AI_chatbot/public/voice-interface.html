<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant - AI Listening</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .voice-container {
            text-align: center;
            z-index: 10;
        }

        .voice-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.2s forwards;
        }

        .voice-subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 3rem;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.4s forwards;
        }

        .wave-container {
            position: relative;
            width: 300px;
            height: 200px;
            margin: 0 auto 2rem;
        }

        .wave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
            transform: translateX(-50%);
            transform-origin: center bottom;
        }

        /* Siri-like wave animation */
        .wave-listening {
            animation: wave-pulse 0.8s ease-in-out infinite alternate;
        }

        .wave-thinking {
            animation: wave-thinking 1.2s ease-in-out infinite alternate;
        }

        .wave-responding {
            animation: wave-response 0.6s ease-in-out infinite alternate;
        }

        /* Central microphone circle */
        .mic-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mic-circle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .mic-circle.listening {
            animation: pulse-listening 1.5s ease-in-out infinite;
            background: rgba(255, 64, 64, 0.3);
            border-color: rgba(255, 64, 64, 0.8);
        }

        .mic-circle.thinking {
            animation: pulse-thinking 2s ease-in-out infinite;
            background: rgba(255, 165, 0, 0.3);
            border-color: rgba(255, 165, 0, 0.8);
        }

        .mic-icon {
            font-size: 2rem;
            color: white;
        }

        .status-text {
            font-size: 1.4rem;
            margin-top: 2rem;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
            min-height: 2rem;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .response-text {
            max-width: 80%;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(20px);
        }

        .response-text.show {
            opacity: 1;
            transform: translateY(0);
            animation: slideInUp 0.5s ease-out forwards;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes wave-pulse {
            0% { height: 20px; opacity: 0.3; }
            100% { height: 100px; opacity: 1; }
        }

        @keyframes wave-thinking {
            0% { height: 30px; opacity: 0.4; }
            50% { height: 80px; opacity: 0.8; }
            100% { height: 45px; opacity: 0.6; }
        }

        @keyframes wave-response {
            0% { height: 15px; opacity: 0.6; }
            100% { height: 120px; opacity: 1; }
        }

        @keyframes pulse-listening {
            0% { 
                box-shadow: 0 0 0 0 rgba(255, 64, 64, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }
            70% { 
                box-shadow: 0 0 0 20px rgba(255, 64, 64, 0);
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(255, 64, 64, 0);
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes pulse-thinking {
            0% { 
                box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }
            70% { 
                box-shadow: 0 0 0 15px rgba(255, 165, 0, 0);
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(255, 165, 0, 0);
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .voice-title {
                font-size: 2rem;
            }
            
            .voice-subtitle {
                font-size: 1rem;
            }
            
            .wave-container {
                width: 250px;
                height: 150px;
            }
            
            .mic-circle {
                width: 70px;
                height: 70px;
            }
            
            .mic-icon {
                font-size: 1.8rem;
            }
            
            .status-text {
                font-size: 1.2rem;
            }
            
            .response-text {
                max-width: 90%;
                padding: 15px;
            }
        }

        /* Loading dots animation */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="closeVoiceInterface()" title="Close">Ã—</button>
    
    <div class="voice-container">
        <h1 class="voice-title">AI Voice Assistant</h1>
        <p class="voice-subtitle">Speak naturally, I'm listening</p>
        
        <div class="wave-container">
            <!-- Generate wave elements -->
            <div class="wave" style="left: 10%; animation-delay: 0s;"></div>
            <div class="wave" style="left: 15%; animation-delay: 0.1s;"></div>
            <div class="wave" style="left: 20%; animation-delay: 0.2s;"></div>
            <div class="wave" style="left: 25%; animation-delay: 0.3s;"></div>
            <div class="wave" style="left: 30%; animation-delay: 0.4s;"></div>
            <div class="wave" style="left: 35%; animation-delay: 0.5s;"></div>
            <div class="wave" style="left: 40%; animation-delay: 0.6s;"></div>
            <div class="wave" style="left: 45%; animation-delay: 0.7s;"></div>
            
            <div class="mic-circle" id="micCircle" onclick="toggleVoiceRecording()">
                <span class="mic-icon" id="micIcon">ðŸŽ¤</span>
            </div>
            
            <div class="wave" style="left: 55%; animation-delay: 0.7s;"></div>
            <div class="wave" style="left: 60%; animation-delay: 0.6s;"></div>
            <div class="wave" style="left: 65%; animation-delay: 0.5s;"></div>
            <div class="wave" style="left: 70%; animation-delay: 0.4s;"></div>
            <div class="wave" style="left: 75%; animation-delay: 0.3s;"></div>
            <div class="wave" style="left: 80%; animation-delay: 0.2s;"></div>
            <div class="wave" style="left: 85%; animation-delay: 0.1s;"></div>
            <div class="wave" style="left: 90%; animation-delay: 0s;"></div>
        </div>
        
        <div class="status-text" id="statusText">Click the microphone to start</div>
        
        <div class="response-text" id="responseText"></div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        let isProcessing = false;
        const waves = document.querySelectorAll('.wave');
        const micCircle = document.getElementById('micCircle');
        const micIcon = document.getElementById('micIcon');
        const statusText = document.getElementById('statusText');
        const responseText = document.getElementById('responseText');

        // Initialize speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    console.log('Speech recognition started');
                    setListeningState(true);
                };

                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        transcript += event.results[i][0].transcript;
                    }
                    
                    if (event.results[event.results.length - 1].isFinal) {
                        console.log('Final transcript:', transcript);
                        processVoiceInput(transcript);
                    } else {
                        statusText.textContent = `Listening: "${transcript}"`;
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    setIdleState();
                    statusText.textContent = 'Error: ' + event.error + '. Click to try again.';
                };

                recognition.onend = function() {
                    console.log('Speech recognition ended');
                    if (!isProcessing) {
                        setIdleState();
                    }
                };
            } else {
                statusText.textContent = 'Speech recognition not supported in this browser';
            }
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                statusText.textContent = 'Speech recognition not available';
                return;
            }

            if (isRecording) {
                recognition.stop();
                setIdleState();
            } else {
                recognition.start();
            }
        }

        function setListeningState(listening) {
            isRecording = listening;
            micCircle.className = listening ? 'mic-circle listening' : 'mic-circle';
            micIcon.textContent = listening ? 'ðŸŽ™ï¸' : 'ðŸŽ¤';
            statusText.textContent = listening ? 'Listening...' : 'Click the microphone to start';
            
            waves.forEach(wave => {
                wave.className = listening ? 'wave wave-listening' : 'wave';
            });

            if (listening) {
                // Notify parent window about voice activity
                if (window.opener) {
                    window.opener.postMessage({ type: 'voiceActivity', isActive: true }, '*');
                }
            }
        }

        function setThinkingState() {
            isProcessing = true;
            micCircle.className = 'mic-circle thinking';
            micIcon.textContent = 'ðŸ¤”';
            statusText.innerHTML = 'Thinking<span class="loading-dots"></span>';
            
            waves.forEach(wave => {
                wave.className = 'wave wave-thinking';
            });
        }

        function setRespondingState() {
            micCircle.className = 'mic-circle';
            micIcon.textContent = 'ðŸ’¬';
            statusText.textContent = 'Responding...';
            
            waves.forEach(wave => {
                wave.className = 'wave wave-responding';
            });
        }

        function setIdleState() {
            isRecording = false;
            isProcessing = false;
            micCircle.className = 'mic-circle';
            micIcon.textContent = 'ðŸŽ¤';
            statusText.textContent = 'Click the microphone to start';
            
            waves.forEach(wave => {
                wave.className = 'wave';
            });

            // Notify parent window about voice activity end
            if (window.opener) {
                window.opener.postMessage({ type: 'voiceActivity', isActive: false }, '*');
            }
        }

        async function processVoiceInput(transcript) {
            if (!transcript.trim()) {
                setIdleState();
                return;
            }

            setThinkingState();

            try {
                // Get current user from parent window
                const currentUser = window.opener ? 
                    window.opener.currentUser : 
                    JSON.parse(localStorage.getItem('currentUser') || 'null');

                const response = await fetch('http://localhost:3000/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: transcript,
                        userId: currentUser ? currentUser.username : null
                    })
                });

                const data = await response.json();
                
                if (data.answer) {
                    setRespondingState();
                    displayResponse(data.answer);
                    speakResponse(data.answer);
                } else {
                    throw new Error('No response received');
                }

            } catch (error) {
                console.error('Error processing voice input:', error);
                setIdleState();
                displayResponse("I'm sorry, I encountered an error processing your request. Please try again.");
                statusText.textContent = 'Error occurred. Click to try again.';
            }
        }

        function displayResponse(text) {
            responseText.textContent = text;
            responseText.classList.add('show');
            
            // Hide response after 10 seconds
            setTimeout(() => {
                responseText.classList.remove('show');
            }, 10000);
        }

        function speakResponse(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 0.8;

                // Try to find an appropriate voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.includes('en-IN') || 
                    voice.name.toLowerCase().includes('indian') ||
                    voice.lang.includes('en-US')
                );

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                utterance.onstart = function() {
                    setRespondingState();
                };

                utterance.onend = function() {
                    setTimeout(() => {
                        setIdleState();
                    }, 1000);
                };

                speechSynthesis.speak(utterance);
            } else {
                // If speech synthesis is not available, just return to idle state
                setTimeout(() => {
                    setIdleState();
                }, 2000);
            }
        }

        function closeVoiceInterface() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            // Notify parent window that voice interface is closing
            if (window.opener) {
                window.opener.postMessage({ type: 'voiceClosed' }, '*');
            }

            window.close();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
            
            // Auto-start recording if opened from voice button
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('autoStart') === 'true') {
                setTimeout(() => {
                    toggleVoiceRecording();
                }, 1000);
            }

            // Load voices when they become available
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = function() {
                    // Voices are now loaded
                };
            }
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                toggleVoiceRecording();
            } else if (event.code === 'Escape') {
                closeVoiceInterface();
            }
        });

        // Prevent accidental closing
        window.addEventListener('beforeunload', function(event) {
            if (isRecording || isProcessing) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
    </script>
</body>
</html>
