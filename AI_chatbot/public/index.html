<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learning Voice AI Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom right, #e8f0ff, #f8fbff);
            color: #2e2e2e;
        }
        .container { max-width: 900px; margin: 40px auto; padding: 20px; }
        .header { position: relative; text-align: center; margin-bottom: 30px; }
        .nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .nav button { padding: 12px 24px; border: none; border-radius: 25px; background: #f0f4fa; color: #2c3e50; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .nav button.active, .nav button:hover { background: #dbeafe; }
        .page { display: none; background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.07); }
        .page.active { display: block; }
        .login-form { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border-radius: 10px; background: #f8fafc; color: #2c3e50; border: 1px solid #d0d7de; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; background: linear-gradient(45deg, #1976d2, #0d47a1); color: white; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .btn:hover { background: linear-gradient(45deg, #0d47a1, #1976d2); }
        .chat-messages { height: 400px; overflow-y: auto; background: #f3f6fa; border-radius: 15px; margin-bottom: 20px; padding: 15px; }
        .message { margin-bottom: 15px; padding: 12px; border-radius: 15px; max-width: 80%; }
        .user-message { background-color: #dbeafe; margin-left: auto; text-align: right; }
        .ai-message { background: #e8eaf6; margin-right: auto; }
        .message-text { margin-top: 5px; line-height: 1.5; word-wrap: break-word; }
        
        .code-block { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; margin: 10px 0; overflow: hidden; }
        .code-header { background: #e9ecef; padding: 8px 12px; font-size: 12px; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6; }
        .code-block pre { margin: 0; padding: 12px; background: #f8f9fa; overflow-x: auto; }
        .code-block code { font-family: 'Courier New', Consolas, monospace; font-size: 14px; line-height: 1.4; color: #212529; }
        .inline-code { background: #f1f3f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', Consolas, monospace; font-size: 13px; color: #d63384; }
        
        .input-area { display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; padding: 15px; border: none; border-radius: 25px; background: #f0f4fa; color: #222; font-size: 16px; }
        
        .voice-btn { 
            width: 48px; 
            height: 48px; 
            border: none; 
            border-radius: 50%; 
            background: #1976d2; 
            color: white; 
            cursor: pointer; 
            font-size: 24px; 
            position: relative;
            transition: all 0.3s ease;
        }
        
        .voice-btn:hover { background: #0d47a1; transform: scale(1.05); }
        .voice-btn.recording { background: #e17055; animation: pulse 1s infinite; }
        .voice-btn.processing { background: #f39c12; animation: pulse-slow 2s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulse-slow { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .suggestions { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .suggestion { background-color: #fcfcfc; color: #000; border: 1px solid #ccc; padding: 8px 12px; border-radius: 20px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .suggestion:hover { background-color: #f0f0f0; transform: translateY(-2px); }
        .admin-card { background: #ffffff; padding: 28px; border-radius: 16px; box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .admin-tab { padding: 10px 20px; border: none; border-radius: 8px; background: #f0f4fa; cursor: pointer; }
        .admin-tab.active { background: #1976d2; color: white; }
        .admin-content { display: none; }
        .admin-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #1976d2; }
        .stat-label { color: #666; margin-top: 5px; }
        .logs-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .logs-table th, .logs-table td { padding: 8px; border-bottom: 1px solid #eaeaea; text-align: left; }
        .logs-table th { background: #f7f7fb; font-weight: 600; }
        .status { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 25px; background: #00b894; color: white; font-size: 14px; z-index: 1000; }
        .status.offline { background: #e17055; }
        .status.phi3-error { background: #f39c12; }
        .hidden { display: none !important; }
        .notification { position: fixed; top: 70px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: 600; z-index: 1001; opacity: 0; transform: translateX(300px); transition: all 0.3s ease; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background: #00b894; }
        .notification.error { background: #e17055; }
        .notification.warning { background: #f39c12; }
        .typing-indicator { display: none; align-items: center; gap: 5px; padding: 10px; }
        .typing-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
        
        .chat-layout { display: flex; gap: 20px; }
        .chat-sidebar { width: 300px; background: #f8fafc; border-radius: 15px; padding: 20px; max-height: 600px; overflow-y: auto; }
        .chat-main { flex: 1; }
        .chat-session-item { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; }
        .chat-session-item:hover { border-color: #dbeafe; transform: translateY(-2px); }
        .chat-session-item.active { border-color: #1976d2; background: #e3f2fd; }
        .chat-session-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .chat-session-preview { font-size: 12px; color: #666; margin-bottom: 5px; }
        .chat-session-meta { font-size: 11px; color: #999; display: flex; justify-content: space-between; }
        .chat-session-delete { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer; }
        .chat-session-delete:hover { background: #c0392b; }
        .context-indicator { background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 8px; margin-bottom: 15px; font-size: 12px; color: #0c5460; }

        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #1976d2;
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-toggle:hover { background: #0d47a1; transform: scale(1.05); }
        .chat-sidebar.hidden { transform: translateX(-100%); opacity: 0; }
        .chat-container { flex: 1; display: flex; flex-direction: column; transition: all 0.3s ease; }
        .chat-container.expanded { margin-left: 0; }
        
        /* Error message styles */
        .error-message { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .success-message { background: #dcfce7; border: 1px solid #bbf7d0; color: #16a34a; padding: 12px; border-radius: 8px; margin-bottom: 15px; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .nav { gap: 10px; flex-wrap: wrap; }
            .nav button { padding: 10px 16px; font-size: 14px; }
            .input-area { flex-direction: column; align-items: stretch; gap: 10px; }
            .voice-btn { width: 100%; height: 48px; border-radius: 25px; }
            .stats-grid { grid-template-columns: 1fr; }
            .chat-layout { flex-direction: column; }
            .chat-sidebar { width: 100%; max-height: 200px; }
            .chat-sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 999; transform: translateX(-100%); opacity: 0; }
            .chat-sidebar.mobile-open { transform: translateX(0); opacity: 1; }
            .chat-container { margin-left: 0; }
            .sidebar-toggle { left: 15px; font-size: 16px; padding: 6px 10px; }
        }

        @media (max-width: 768px) { .chat-sidebar.hidden { display: none; } }
        @media (min-width: 769px) { .chat-container { margin-left: 300px; } .chat-sidebar.hidden + .chat-container { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="status" id="networkStatus">
        <span id="statusText">Checking...</span>
    </div>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  Learning AI Assistant</h1>
        </div>
        
        <div class="nav">
            <button onclick="showPage('login')" class="nav-btn active" id="loginNav">Login</button>
            <button onclick="showPage('register')" class="nav-btn" id="registerNav">Register</button>
            <button onclick="showPage('chat')" class="nav-btn hidden" id="chatNav">Chat</button>
            <button onclick="showPage('admin')" class="nav-btn hidden" id="adminNav">Admin</button>
            <button onclick="logout()" class="nav-btn hidden" id="logoutNav">Logout</button>
        </div>
        
        <!-- Login Page -->
        <div id="login" class="page active">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Welcome Back</h2>
                <div id="loginMessage"></div>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="register" class="page">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Create Account</h2>
                <div id="registerMessage"></div>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="regUsername" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="Create a password (min 6 characters)" required>
                    </div>
                    <button type="submit" class="btn">Register</button>
                </form>
            </div>
        </div>
        
        <!-- Chat Page -->
        <div id="chat" class="page">
            <div class="chat-layout">
                <!-- Chat Sidebar -->
                <div class="chat-sidebar" id="chatSidebar">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h3 style="margin: 0; color: #2c3e50;">Chat History</h3>
                        </div>
                        <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px;" onclick="startNewChat()">+ New Chat</button>
                    </div>
        
                    <div id="chatSessionsList" class="chat-sessions-list">
                        <p style="color: #666; text-align: center;">Loading chat history...</p>
                    </div>
                </div>
        
                <!-- Main Chat Area -->
                <div class="chat-main" id="chatContainer">
                    <div class="suggestions" id="suggestions">
                        <button class="suggestion" onclick="askSuggestion('What does Premade Innovation do?')">What does Premade Innovation do?</button>
                        <button class="suggestion" onclick="askSuggestion('Who founded the company?')">Who founded the company?</button>
                        <button class="suggestion" onclick="askSuggestion('How can I join the team?')">How can I join?</button>
                        <button class="suggestion" onclick="askSuggestion('What services do you offer?')">What services do you offer?</button>
                        <button class="suggestion" onclick="askSuggestion('What technologies do you use?')">What technologies do you use?</button>
                        <button class="suggestion" onclick="askSuggestion('What is artificial intelligence?')">What is AI?</button>
                        <button class="suggestion" onclick="askSuggestion('Latest news in technology')">Tech News</button>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <strong>AI:</strong> Hello! I'm your learning AI assistant with contextual memory. I can remember our conversation and provide follow-up responses. Ask me anything or click the microphone for voice interaction!
                        </div>
                    </div>
        
                    <div class="typing-indicator" id="typingIndicator">
                        <span>AI is thinking and learning</span>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
        
                    <div class="input-area">
                        <button id="sidebarToggle" style="
                            padding: 4px;
                            font-size: 16px;
                            line-height: 1;
                            background: transparent;
                            border: none;
                            cursor: pointer;
                            color: #2c3e50;
                            transition: color 0.2s;
                        " onclick="toggleSidebar()">â˜°</button>
                        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
                        <button class="voice-btn" id="voiceBtn" onclick="openVoiceInterface()" title="Click for voice interface">ðŸŽ¤</button>
                        <button class="btn" style="width:auto;min-width:100px;" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Page -->
        <div id="admin" class="page">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('overview')">Overview</button>
                <button class="admin-tab" onclick="showAdminTab('phi3')">System Status</button>
                <button class="admin-tab" onclick="showAdminTab('users')">Users</button>
                <button class="admin-tab" onclick="showAdminTab('knowledge')">Knowledge Gaps</button>
                <button class="admin-tab" onclick="showAdminTab('popular')">Popular Questions</button>
                <button class="admin-tab" onclick="showAdminTab('learning')">Learning Stats</button>
                <button class="admin-tab" onclick="showAdminTab('logs')">Conversation Logs</button>
            </div>
            
            <div id="overview" class="admin-content active">
                <div class="admin-card">
                    <h3>System Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalQuestions">0</div>
                            <div class="stat-label">Questions Asked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="knowledgeEntries">0</div>
                            <div class="stat-label">Knowledge Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="learningRate">0%</div>
                            <div class="stat-label">Learning Rate</div>
                        </div>
                    </div>
                    <div id="systemStatus"></div>
                </div>
            </div>
            
            <div id="users" class="admin-content">
                <div class="admin-card">
                    <h3>ðŸ‘¥ User Management</h3>
                    <div id="usersDisplay">Loading users...</div>
                </div>
            </div>
            
            <div id="phi3" class="admin-content">
                <div class="admin-card">
                    <h3>ðŸ¤– System Status</h3>
                    <div id="phi3AdminStatus">Loading...</div>
                    <button class="btn" style="width:auto;margin-top:15px;" onclick="checkPhi3Status()">Refresh System Status</button>
                </div>
            </div>
            
            <div id="knowledge" class="admin-content">
                <div class="admin-card">
                    <h3>Knowledge Gaps</h3>
                    <p>Questions that users ask but the AI couldn't answer well:</p>
                    <div id="knowledgeGapsDisplay">Loading...</div>
                </div>
            </div>
            
            <div id="popular" class="admin-content">
                <div class="admin-card">
                    <h3>Popular Questions</h3>
                    <p>Most frequently asked questions:</p>
                    <div id="popularQuestionsDisplay">Loading...</div>
                </div>
            </div>
            
            <div id="learning" class="admin-content">
                <div class="admin-card">
                    <h3>ðŸ§  Learning Statistics</h3>
                    <div id="learningStatsDisplay">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="learnedResponses">0</div>
                                <div class="stat-label">Learned Responses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="googleSearches">0</div>
                                <div class="stat-label">Google Searches</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="phi3Responses">0</div>
                                <div class="stat-label">AI Responses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="learningRateDisplay">0%</div>
                                <div class="stat-label">Learning Success Rate</div>
                            </div>
                        </div>
                        <p><em>The AI learns from every interaction to provide better responses over time.</em></p>
                    </div>
                </div>
            </div>
            
            <div id="logs" class="admin-content">
                <div class="admin-card">
                    <h3>Conversation Logs</h3>
                    <div id="adminLogsDisplay">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let currentUser = null;
        let voiceWindow = null;
        let isOnline = navigator.onLine;
        let currentAdminTab = 'overview';
        let phi3Status = { status: 'unknown', phi3Available: false };
        let currentSessionId = null;
        let chatSessions = [];
        let isLoadingSession = false;
        let sidebarVisible = window.innerWidth > 768;

        document.addEventListener('DOMContentLoaded', function() {
            updateNetworkStatus();
            checkServerStatus();
            checkPhi3Status();
            setupEventListeners();
            
            // Listen for messages from voice interface
            window.addEventListener('message', function(event) {
                if (event.data.type === 'voiceActivity') {
                    handleVoiceActivity(event.data.isActive);
                } else if (event.data.type === 'voiceClosed') {
                    voiceWindow = null;
                }
            });
        });

        function setupEventListeners() {
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebarVisible = true;
                } else {
                    sidebarVisible = false;
                }
                updateSidebarVisibility();
            });
        }

        function handleVoiceActivity(isActive) {
            const voiceBtn = document.getElementById('voiceBtn');
            if (isActive) {
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'Voice interface active';
            } else {
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'Click for voice interface';
            }
        }

        function openVoiceInterface() {
            if (voiceWindow && !voiceWindow.closed) {
                voiceWindow.focus();
                return;
            }
            
            const width = 600;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            voiceWindow = window.open(
                'voice-interface.html?autoStart=true',
                'voiceInterface',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=no,menubar=no,toolbar=no,status=no`
            );
            
            if (voiceWindow) {
                voiceWindow.focus();
            } else {
                showNotification('Please allow popups to use voice interface', 'warning');
            }
        }

        function toggleSidebar() {
            sidebarVisible = !sidebarVisible;
            updateSidebarVisibility();
        }

        function updateSidebarVisibility() {
            const chatSidebar = document.getElementById('chatSidebar');
            const chatContainer = document.getElementById('chatContainer');
            
            if (sidebarVisible) {
                chatSidebar.classList.remove('hidden');
                chatContainer.classList.remove('expanded');
                if (window.innerWidth <= 768) {
                    chatSidebar.classList.add('mobile-open');
                }
            } else {
                chatSidebar.classList.add('hidden');
                chatContainer.classList.add('expanded');
                if (window.innerWidth <= 768) {
                    chatSidebar.classList.remove('mobile-open');
                }
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3000/api/test');
                const data = await response.json();
                console.log('Server status:', data);
                
                if (currentUser && currentUser.role === 'admin') {
                    displaySystemStatus(data);
                }
            } catch (error) {
                console.error('Server check failed:', error);
                showNotification('Server connection failed. Please start the server.', 'warning');
            }
        }

        async function checkPhi3Status() {
            try {
                const response = await fetch('http://localhost:3000/api/phi3/status');
                const data = await response.json();
                phi3Status = data;
                updatePhi3StatusDisplay(data);
            } catch (error) {
                console.error('AI status check failed:', error);
                phi3Status = { status: 'error', phi3Available: false, error: error.message };
                updatePhi3StatusDisplay(phi3Status);
            }
        }

        function updatePhi3StatusDisplay(status) {
            const networkStatus = document.getElementById('networkStatus');
            
            if (status.status === 'healthy' && status.phi3Available) {
                networkStatus.className = 'status';
                document.getElementById('statusText').textContent = 'All Systems Ready';
            } else {
                networkStatus.className = 'status phi3-error';
                document.getElementById('statusText').textContent = 'Partial Systems';
            }
        }

        function updateNetworkStatus() {
            isOnline = navigator.onLine;
            if (!isOnline) {
                const statusElement = document.getElementById('networkStatus');
                statusElement.className = 'status offline';
                document.getElementById('statusText').textContent = 'Offline';
            } else {
                checkPhi3Status();
            }
        }

        function showMessage(elementId, message, type = 'error') {
            const messageDiv = document.getElementById(elementId);
            messageDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        async function register(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            
            try {
                const response = await fetch('http://localhost:3000/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, username, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('registerMessage', data.message, 'success');
                    setTimeout(() => {
                        showPage('login');
                        document.getElementById('loginUsername').value = username;
                    }, 2000);
                    
                    // Clear form
                    document.getElementById('regName').value = '';
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                } else {
                    showMessage('registerMessage', data.error);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('registerMessage', 'Network error. Please check if the server is running.');
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('sessionToken', data.sessionToken);
                    
                    showLoggedInUI();
                    showNotification('Login successful!', 'success');
                    
                    if (currentUser.role === 'admin') {
                        showPage('admin');
                        loadAdminData();
                    } else {
                        showPage('chat');
                        loadUserChatSessions();
                        startNewChat();
                    }
                } else {
                    showMessage('loginMessage', data.error);
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('loginMessage', 'Network error. Please check if the server is running.');
            }
        }

        function showLoggedInUI() {
            document.getElementById('chatNav').classList.remove('hidden');
            document.getElementById('logoutNav').classList.remove('hidden');
            document.getElementById('loginNav').classList.add('hidden');
            document.getElementById('registerNav').classList.add('hidden');
            if (currentUser && currentUser.role === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
            }
        }

        function showLoggedOutUI() {
            document.getElementById('chatNav').classList.add('hidden');
            document.getElementById('adminNav').classList.add('hidden');
            document.getElementById('logoutNav').classList.add('hidden');
            document.getElementById('loginNav').classList.remove('hidden');
            document.getElementById('registerNav').classList.remove('hidden');
        }

        function logout() {
            if (voiceWindow && !voiceWindow.closed) {
                voiceWindow.close();
            }
            
            currentUser = null;
            currentSessionId = null;
            chatSessions = [];
            
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionToken');
            
            showLoggedOutUI();
            showPage('login');
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showNotification('Logged out successfully', 'success');
        }

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            
            if (pageId === 'admin' && currentUser && currentUser.role === 'admin') {
                loadAdminData();
            }
        }

        async function loadAdminData() {
            updateAdminStats();
            loadAdminTabData(currentAdminTab);
        }

        function showAdminTab(tabId) {
            const tabs = document.querySelectorAll('.admin-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            const contents = document.querySelectorAll('.admin-content');
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            currentAdminTab = tabId;
            
            loadAdminTabData(tabId);
        }

        async function loadAdminTabData(tabId) {
            switch(tabId) {
                case 'users':
                    await loadUsersAdmin();
                    break;
                case 'phi3':
                    await checkPhi3Status();
                    break;
            }
        }

        async function loadUsersAdmin() {
            try {
                const response = await fetch('http://localhost:3000/api/admin/users');
                const data = await response.json();
                
                let html = '<div class="stats-grid" style="margin-bottom: 20px;">';
                html += `<div class="stat-card"><div class="stat-number">${data.users.length}</div><div class="stat-label">Total Users</div></div>`;
                html += '</div>';
                
                html += '<table class="logs-table"><tr><th>Name</th><th>Username</th><th>Email</th><th>Registered</th><th>Questions</th><th>Last Activity</th></tr>';
                
                data.users.forEach(user => {
                    html += `<tr>
                        <td>${user.name}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${new Date(user.registeredAt).toLocaleDateString()}</td>
                        <td>${user.statistics.totalQuestions}</td>
                        <td>${user.statistics.lastActivity !== 'Never' ? new Date(user.statistics.lastActivity).toLocaleString() : 'Never'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                document.getElementById('usersDisplay').innerHTML = html;
            } catch (error) {
                document.getElementById('usersDisplay').innerHTML = '<p>Unable to load users data.</p>';
            }
        }

        function updateAdminStats() {
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('totalQuestions').textContent = '0';
            document.getElementById('knowledgeEntries').textContent = '50+';
            document.getElementById('learningRate').textContent = '85%';
        }

        async function loadUserChatSessions() {
            // Implementation for loading chat sessions
        }

        async function startNewChat() {
            // Implementation for starting new chat
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            displayMessage(message, 'user');
            showTypingIndicator();
            
            try {
                const response = await getAnswer(message);
                hideTypingIndicator();
                displayMessage(response.answer, 'ai');
            } catch (error) {
                hideTypingIndicator();
                displayMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        async function getAnswer(message) {
            const response = await fetch('http://localhost:3000/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: message,
                    userId: currentUser ? currentUser.username : null
                })
            });
            
            return await response.json();
        }

        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI'}:</strong> ${text}`;
            document.getElementById('chatMessages').appendChild(messageDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 4000);
        }

        function askSuggestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }
    </script>
</body>
</html>
